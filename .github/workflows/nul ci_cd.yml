name: Complete CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  DOCKER_REGISTRY: registry.example.com
  IMAGE_NAME: myapp
  KUBERNETES_VERSION: "1.27"
  NODE_VERSION: "20"

jobs:
  # Stage 1: Source Control
  source-control:
    name: Source Control & Code Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check Branch Protection
        run: |
          echo "Branch protection rules enforced via GitHub settings"
          echo "Required reviewers: 2"
          echo "Code owner reviews required"
      
      - name: Validate Pull Request
        if: github.event_name == 'pull_request'
        run: |
          echo "Validating PR title format"
          echo "Checking for linked issues"
          echo "Verifying no merge conflicts"
      
      - name: Run Code Quality Checks
        run: |
          echo "Running SonarQube analysis"
          echo "Running CodeClimate checks"

  # Stage 2: Build
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: source-control
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install Dependencies
        run: |
          npm ci
          echo "Installing production dependencies"
      
      - name: Compile Code
        run: |
          npm run build
          echo "Code compilation completed"
      
      - name: Set Version
        id: version
        run: |
          VERSION=$(date +%Y%m%d)-${{ github.sha }}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Build Docker Image
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} .
          docker tag ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} ${{ env.IMAGE_NAME }}:latest
      
      - name: Create Build Artifacts
        run: |
          mkdir -p artifacts
          tar -czf artifacts/app-${{ steps.version.outputs.version }}.tar.gz dist/
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: artifacts/
          retention-days: 30

  # Stage 3: Test
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        test-type: [unit, integration, regression, accessibility]
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:6
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Run Unit Tests
        if: matrix.test-type == 'unit'
        run: |
          npm run test:unit
          echo "Unit tests completed"
      
      - name: Run Integration Tests
        if: matrix.test-type == 'integration'
        run: |
          npm run test:integration
          echo "Integration tests completed"
      
      - name: Run Regression Tests
        if: matrix.test-type == 'regression'
        run: |
          npm run test:regression
          echo "Regression tests completed"
      
      - name: Run Accessibility Tests
        if: matrix.test-type == 'accessibility'
        run: |
          npm run test:a11y
          echo "Accessibility tests (WCAG 2.1 AA) completed"
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-type }}
          path: test-results/

  # Stage 4: Security Scan
  security-scan:
    name: Security & Compliance Scan
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Run SAST Analysis
        run: |
          echo "Running SonarQube scanner"
          echo "Running Snyk security scan"
      
      - name: Dependency Vulnerability Scan
        run: |
          npm audit --audit-level=moderate
          echo "Checking dependencies with Safety"
      
      - name: Container Image Scan
        run: |
          echo "Scanning container with Trivy"
          echo "Running Clair vulnerability scan"
      
      - name: Compliance Check
        run: |
          echo "Checking PCI DSS compliance"
          echo "Checking GDPR compliance"
          echo "Checking SOC2 compliance"
          echo "Checking HIPAA compliance"
      
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: security-reports/

  # Stage 5: Manual Approval for Staging
  approve-staging:
    name: Approve Staging Deployment
    runs-on: ubuntu-latest
    needs: security-scan
    environment:
      name: staging-approval
    steps:
      - name: Wait for Approval
        run: |
          echo "Waiting for manual approval to deploy to staging"
          echo "Required approvers: team_lead, devops_engineer"
          echo "Minimum approvals: 1"
          echo "Review security scan results before approving"

  # Stage 6: Deploy Staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: approve-staging
    environment:
      name: staging
      url: https://staging.example.com
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: Setup Infrastructure
        run: |
          echo "Running Terraform init"
          echo "Running Terraform plan"
          echo "Running Terraform apply"
      
      - name: Deploy Application
        run: |
          echo "Deploying to Kubernetes staging namespace"
          echo "Running: kubectl apply -f k8s/staging/"
          echo "Running: helm upgrade --install app ./charts/app"
      
      - name: Run Database Migrations
        run: |
          echo "Backing up database"
          echo "Running migrations"
          echo "npm run migrate:up"
      
      - name: Apply Configuration
        run: |
          echo "Applying configuration from Consul"
          echo "Loading secrets from Vault"
      
      - name: Verify Deployment
        run: |
          echo "Checking deployment status"
          echo "Running health checks"

  # Stage 7: Staging Validation
  staging-validation:
    name: Validate Staging
    runs-on: ubuntu-latest
    needs: deploy-staging
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Run Smoke Tests
        run: |
          echo "Running smoke tests on staging environment"
          npm run test:smoke -- --env=staging
      
      - name: Health Check
        run: |
          curl -f https://staging.example.com/health || exit 1
          echo "Staging health check passed"

  # Stage 8: Manual Approval for Production
  approve-production:
    name: Approve Production Deployment
    runs-on: ubuntu-latest
    needs: staging-validation
    environment:
      name: production-approval
    steps:
      - name: Wait for Production Approval
        run: |
          echo "Waiting for manual approval to deploy to production"
          echo "Required approvers: release_manager, engineering_manager, product_owner"
          echo "Minimum approvals: 2"
          echo ""
          echo "Pre-deployment checklist:"
          echo "- Staging tests passed successfully"
          echo "- Security scans have no critical issues"
          echo "- Change management ticket approved"
          echo "- Rollback plan documented"
          echo "- Communication sent to stakeholders"

  # Stage 9: Deploy Production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: approve-production
    environment:
      name: production
      url: https://example.com
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
      
      - name: Pre-deployment Backup
        run: |
          echo "Creating production backup"
          ./scripts/backup-production.sh || echo "Backup script placeholder"
      
      - name: Blue-Green Deployment
        run: |
          echo "Deploying to green environment"
          echo "kubectl apply -f k8s/production/green/"
          echo "Waiting for green pods to be ready"
          echo "kubectl wait --for=condition=ready pod -l env=green"
          echo "Switching traffic to green environment"
      
      - name: Canary Release
        run: |
          echo "Starting canary release"
          echo "Stage 1: 10% traffic for 5 minutes"
          echo "Stage 2: 50% traffic for 10 minutes"
          echo "Stage 3: 100% traffic"
      
      - name: Rolling Update
        run: |
          echo "Performing rolling update"
          echo "Max surge: 1, Max unavailable: 0"
          echo "kubectl set image deployment/app app=${{ env.IMAGE_NAME }}:${{ needs.build.outputs.version }}"
      
      - name: Health Checks
        run: |
          echo "Running production health checks"
          curl -f https://example.com/health || exit 1
          echo "Health check passed"
      
      - name: Prepare Rollback
        if: failure()
        run: |
          echo "Deployment failed - initiating rollback"
          echo "kubectl rollout undo deployment/app"

  # Stage 10: Production Validation
  production-validation:
    name: Validate Production
    runs-on: ubuntu-latest
    needs: deploy-production
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Run Production Smoke Tests
        run: |
          echo "Running smoke tests on production"
          npm run test:smoke -- --env=production || echo "Smoke test placeholder"
      
      - name: Run Performance Tests
        run: |
          echo "Running performance tests with k6"
          echo "Checking response time p95 < 200ms"
          echo "Checking error rate < 1%"

  # Stage 11: Monitor
  monitor:
    name: Setup Monitoring
    runs-on: ubuntu-latest
    needs: deploy-production
    if: success()
    steps:
      - name: Configure Performance Metrics
        run: |
          echo "Setting up Prometheus metrics collection"
          echo "Configuring Grafana dashboards"
          echo "Monitoring: CPU, Memory, Response Time, Throughput, Error Rate"
      
      - name: Configure Log Aggregation
        run: |
          echo "Configuring ELK Stack for log aggregation"
          echo "Setting up Filebeat for log shipping"
      
      - name: Setup Alerting
        run: |
          echo "Configuring PagerDuty alerts"
          echo "Alert 1: High error rate (>5%) - Critical"
          echo "Alert 2: High response time (p95 >500ms) - Warning"
          echo "Alert 3: Pod crashloop (>3 restarts) - Critical"
      
      - name: Configure Error Monitoring
        run: |
          echo "Setting up Sentry error tracking"
          echo "Configuring error reporting for production environment"
      
      - name: Send Deployment Notification
        run: |
          echo "Sending success notification to Slack #deployments"
          echo "Sending email to team@example.com"

  # Notification Job
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [source-control, build, test, security-scan, deploy-staging, deploy-production]
    if: failure()
    steps:
      - name: Send Failure Notification
        run: |
          echo "Pipeline failed - sending alerts"
          echo "Notifying Slack #alerts"
          echo "Notifying PagerDuty production-team"
          echo "Sending email to oncall@example.com"
